@using prj_Traveldate_Core.ViewModels;
@model CArticleViewModel

@{
    ViewData["Title"] = "ArticleView";
}
@section Styles{
    <style>
        .reply-input {
            height: 100px !important;
        }

        #btnReply{
            background: #f8f9fa;
            padding:10px;
            border-radius:5px;
            color:black;
        }

        #btnReply:hover{
                background: #d3d4d5;
        }
    </style>
}

<div class="row justify-content-center pb-4">
    <div class="col-10 bg-white rounded-3">
        <div class="divide-line">
        <div class="divide-line pl-4 pt-4">
            <h2>揪3~5人遊蘭嶼</h2>
              <h6>@Model.forum.Title</h6>
        </div>
            <div class="mb-4 pl-4">
                <img src="~/icons/icons8-eye-24.png" />　<span>@Model.forum.Watches　|</span>
                <img src="~/icons/icons8-like-24.png" />　<span id="likes">@Model.forum.Likes　|</span>
                <img src="~/icons/icons8-talk-24.png" />　<span>@Model.replys.Count()</span>
        </div>
            <div class="d-flex divide-line pl-4 pr-4 pb-4">
            <div>
                <img src="~/icons/icons8-person-female-100.png" />
            </div>
            <div class="col">
                <h4>王曉明</h4>
                <div>
                    <span>發文日期 : 2023/07/15　|　</span>
                    <span><img src="~/icons/icons8-position-16.png" />台東</span>
                </div>
                <div>
                    <span><img src="~/icons/icons8-tag-16.png" />　#水上活動　|　#一日遊</span>
                </div>
            </div>
        </div>
      
        <div class="d-flex p-3 justify-content-around">
            <div class="card text-bg-dark col-5 p-0 ">
                <img src="~/images/蘭嶼.jpg" class="card-img h-100" alt="蘭嶼" />
                <div class="card-img-overlay">
                    <div class="align-corner align-text-bottom">
                        <h5 class="card-title fw-bolder text-light">蘭嶼 野銀白沙冷泉</h5>
                        <p class="card-text fs-4 text-black fw-bolder text-light">TWD <span>2999</span><span class="card-text">起</span></p>
                    </div>
                </div>
            </div>
            <div class="card text-bg-dark col-5 p-0">
                <img src="~/images/東清秘境-蘭嶼.png" class="card-img h-100" alt="東清秘境" />
                <div class="card-img-overlay">
                    <div class="align-corner align-text-bottom">
                        <h5 class="card-title fw-bolder text-light">蘭嶼 東清秘境</h5>
                        <p class="card-text fs-4 text-black fw-bolder text-light">TWD <span>399</span><span class="card-text">起</span></p>
                    </div>
                </div>
            </div>
        </div>
        <div class="d-flex p-3 justify-content-start pl-4">
            <p>
                揪旅伴2~3名,女性~<br />
                Day1:野銀白沙冷泉<br />
                Day2:野銀白沙冷泉<br />
                <br />
                費用:大約3500~4000元
            </p>
        </div>
        <div class="d-flex p-3 justify-content-center">
            <img class="col-6" src="~/images/蘭嶼舊燈塔.jpg" width="auto" />
            <img class="col-6" src="~/images/蘭嶼情人洞.jpg" width="auto" />
        </div>
        </div>
        <div name="activeForm" class="d-flex justify-content-around p-2 mt-2 mb-2">
            @*<input type="hidden" name="@Model.forum.ForumListId"/>*@
            <div>
                <img src="~/icons/icons8-like-64.png" />
                <input id="btnLike" class="btn btn-light" type="button" value="讚" />
                <input id="btnCancelLike" class="btn btn-secondary d-none" type="button" value="取消讚" />
             </div>
            <div><img src="~/icons/icons8-talk-64.png" /><a href="#my-reply" id="btnReply">回覆</a></div>
            <div><img src="~/icons/icons8-group-64.png" /><input id="btnJoin" class="btn btn-light" type="button" value="我要跟團" /></div>
        </div>
        <div id="replyBody">
        @foreach (var reply in Model.replys)
        {
            <div class="d-flex divide-line-top" id="reply-@reply.ReplyId">
                <div>
                    @if (reply.Member.Photo != null)
                    {
                        <img src="data:image/jpg;base64,@Convert.ToBase64String(reply.Member.Photo)" class="my-w100-h100" alt="@reply.MemberId">
                    }
                    else
                    {
                        if (reply.Member.Gender == "男")
                        {
                            <img src="~/icons/icons8-person-100.png" class="my-w100-h100" alt="null">
                        }
                        else
                        {
                            <img src="~/icons/icons8-person-female-100.png" class="my-w100-h100" alt="null">
                        }
                    }

                </div>
                <div class="col">
                    <h4>@reply.Member.LastName@reply.Member.FirstName</h4>
                    <div>
                        <span>回覆日期 : @reply.ReplyTime.ToString()</span>
                    </div>
                    <div>
                        <p>@reply.Content</p>
                    </div>
                </div>
            </div>
        }
        </div>
        <div class="pl-4 pr-4">
            <form name="replyForm">
                <input type="hidden" name="ForumListId" value="@Model.forum.ForumListId" />
                <input type="hidden" name="MemberId" value="@Model.member.MemberId" />
                <input type="hidden" name="ReplyTime" value="@DateTime.Now"/>
                @Html.Partial("ReplyToDiv",Model.member)
            </form>
    </div>
    </div>
</div>
<div id="test" class="alert alert-info"></div>
@section Scripts{
    <script>
       /*****按讚/取消讚*****/
        $('#btnLike').click(function (b) {
            b.preventDefault();
            $.post('@Url.Content("~/Forum/Likes")', { "id": @Model.forum.ForumListId, "status": 0}, function (e) {
                $('#likes').text(e+'　|')
                $('#btnLike').hide();
                $('#btnCancelLike').removeClass("d-none")
            })
        })
        $('#btnCancelLike').click(function (b) {
            b.preventDefault();
            $.post('@Url.Content("~/Forum/Likes")', { "id": @Model.forum.ForumListId, "status": 1 }, function (e) {
                $('#likes').text(e + '　|')
                $('#btnCancelLike').addClass("d-none")
                $('#btnLike').show();
            })
        })
      /******留言區即時更新**** */
        const btnSubmit = document.querySelector('#btnSubmit')
        const replyContent = document.querySelector('#replyContent')
        btnSubmit.addEventListener('click',event=>{
            event.preventDefault();
            const formData = new FormData(document.replyForm);
            fetch('@Url.Content("~/Forum/ReplyTo")', {
                body: formData,
                method: "post"
            }).then(response => {
                    console.log(response)
                    if (response.ok) {
                    $('#replyBody').load('@Url.Content("~/Forum/Replied")' + '?id=' + @Model.forum.ForumListId)
                    replyContent.value="";
                    } else {
                        alert('新增失敗,請確認資料')
                    }
                })
        })
    </script>
}